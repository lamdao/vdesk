#!/bin/sh

case "$1" in
	--prefix=*)
		prefix="`echo $1|cut -f2 -d=`";
		;;
	*)
		prefix="/usr/local"
		;;
esac

echo -n "Checking for pkg-config... "
xft_inc=`pkg-config --cflags xft 2>/dev/null`
if [ $? != 0 ]; then
	echo no
	have_pkgcfg=0
	echo -n "Checking for xft-config... "
	xft_inc=`xft-config --cflags 2>/dev/null`
	if [ $? != 0 ]; then
		echo no
		# Work around for old Xft including in XFree 4.0.x
		echo -n "Checking naked Xft lib... "
		for p in /usr/X11R6 /usr/local/X11R6 /opt/X11R6; do
			if [ "`ls $p/lib/libXft.so*`" != "" ]; then
				echo yes
				xft_inc="-I$p/include -I$p/include/freetype -I$p/include/freetype2"
				xft_lib="-L$p/lib -lX11 -lXft -lfreetype"
				break
			fi
		done

		if [ "$xft_inc" = "" ]; then
			echo "* ERROR: You MUST install xft lib to build vdesk!"
			sleep 5
			exit 1
		fi
	else
		echo yes
		xft_lib=`xft-config --libs 2>/dev/null`
	fi
else
	echo yes
	have_pkgcfg=1
	xft_lib=`pkg-config --libs xft 2>/dev/null`
fi

echo -n "Checking Imlib... "
if [ $have_pkgcfg = 1 ]; then
	imlib_inc=`pkg-config --cflags imlib 2>/dev/null`
	if [ $? = 0 ]; then
		imlib_lib=`pkg-config --libs imlib 2>/dev/null`
	fi
fi

if [ "$imlib_inc" = "" ]; then
	imlib_inc=`imlib-config --cflags 2>/dev/null`
	if [ $? != 0 ]; then
		echo no
		echo "* ERROR: You MUST install imlib-1.9.x to build vdesk!"
		sleep 5
		exit 1
	fi
	echo yes
	imlib_lib=`imlib-config --libs 2>/dev/null`
else
	echo yes
fi

echo "XFT_INC=$xft_inc" > Makefile.cfg
echo "XFT_LIB=$xft_lib" >> Makefile.cfg
echo "IMLIB_INC=$imlib_inc" >> Makefile.cfg
echo "IMLIB_LIB=$imlib_lib" >> Makefile.cfg
echo "PREFIX=$prefix" >> Makefile.cfg

echo "Config:"
echo "  Xft include: $xft_inc"
echo "  Xft lib: $xft_lib"
echo "  Imlib include: $imlib_inc"
echo "  Imlib lib: $imlib_lib"
echo
echo "Type \"make\" to start building vdesk"

sys=`uname -s | tr [A-Z] [a-z] | sed -e "s/.*bsd.*/bsd/"`
ln -sf Makefile.$sys Makefile

exit 0
